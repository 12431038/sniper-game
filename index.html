<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スナイパーゲーム（超修正版）</title>
<style>
body { margin:0; overflow:hidden; background:#000; color:#fff; font-family:sans-serif; }
#introArea, #gameArea, #endArea { position:relative; width:100vw; height:100vh; }
#introImg, #introCamera, #endImg, #sniperImg { position:absolute; width:100%; height:100%; object-fit:cover; }
#introCamera { width:200px; height:150px; bottom:20px; right:20px; border:2px solid #fff; z-index:5; display:none; transform:scaleX(-1); }
#startButton { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); padding:15px 30px; font-size:20px; cursor:pointer; z-index:10; }
#restartButton { position:absolute; bottom:20px; left:25%; transform:translateX(-50%); padding:15px 30px; font-size:20px; cursor:pointer; z-index:10; }
#gameArea { display:none; overflow:hidden; }
#sniperImg { position:absolute; left:0; top:0; width:50vw; height:100vh; object-fit:cover; }
#camera { position:absolute; right:0; top:0; width:50vw; height:100vh; object-fit:cover; border-left:2px solid #fff; transform:scaleX(-1); }
#overlay { position:absolute; right:0; top:0; width:50vw; height:100vh; pointer-events:none; }
#scope { position:absolute; width:300px; height:300px; border:3px solid red; border-radius:50%; pointer-events:none; z-index:5; transition:left 0.2s, top 0.2s; }
#timer { position:absolute; bottom:10px; right:10px; font-size:24px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px; z-index:10; }
#hitEffect { position:absolute; width:200px; height:200px; pointer-events:none; display:none; z-index:20; }
</style>
</head>
<body>

<div id="introArea">
  <img id="introImg" src="画像9.png" alt="">
  <video id="introCamera" autoplay muted></video>
  <button id="startButton">ゲーム開始</button>
</div>

<div id="gameArea">
  <img id="sniperImg" src="画像4.png" alt="">
  <video id="camera" autoplay muted></video>
  <canvas id="overlay"></canvas>
  <div id="scope"></div>
  <img id="hitEffect" src="画像10.png">
  <div id="timer">1:00</div>
</div>

<div id="endArea" style="display:none;">
  <img id="endImg" src="" alt="">
  <button id="restartButton" style="display:none;">もう一度遊ぶ</button>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
const startButton = document.getElementById("startButton");
const restartButton = document.getElementById("restartButton");
const introArea = document.getElementById("introArea");
const introImg = document.getElementById("introImg");
const introCamera = document.getElementById("introCamera");
const gameArea = document.getElementById("gameArea");
const sniperImg = document.getElementById("sniperImg");
const camera = document.getElementById("camera");
const overlay = document.getElementById("overlay");
const scope = document.getElementById("scope");
const hitEffect = document.getElementById("hitEffect");
const timerDisplay = document.getElementById("timer");
const endArea = document.getElementById("endArea");
const endImg = document.getElementById("endImg");

let videoStream, scopeTimer, countdownInterval;
let gameTime = 60;
const introImages = ["画像1.png","画像2.png","画像3.png"];
const sniperImages = ["画像4.png","画像5.png","画像6.png"];
const endImages = { lose:"画像7.png", win:"画像8.png" };
let gameEnded = false;

// モデルロード
async function loadModels(){
  await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
}

// イントロ
async function showIntro(){
  startButton.style.display = "none";
  introImg.src = "画像9.png";

  for(let i=0;i<introImages.length;i++){
    introImg.src = introImages[i];
    if(i === 1){
      introCamera.style.display = "block";
      introCamera.style.width = "600px";
      introCamera.style.height = "450px";
      introCamera.style.left = "50%";
      introCamera.style.top = "50%";
      introCamera.style.transform = "translate(-50%, -50%) scaleX(-1)";
      try { videoStream = await navigator.mediaDevices.getUserMedia({ video:true }); introCamera.srcObject = videoStream; } 
      catch(e){ alert("カメラアクセスを許可してください"); return; }
    } else { introCamera.style.display = "none"; }
    await new Promise(res => setTimeout(res, 6000));
  }
  introArea.style.display = "none";
  startGameplay();
}

// ゲーム開始
async function startGameplay(){
  gameEnded = false;
  gameArea.style.display = "block";

  try { videoStream = await navigator.mediaDevices.getUserMedia({ video:true }); camera.srcObject = videoStream; } 
  catch(e){ alert("カメラアクセスを許可してください"); return; }

  sniperImg.src = sniperImages[0];
  setTimeout(()=>{ sniperImg.src = sniperImages[1]; }, 20000);
  setTimeout(()=>{ sniperImg.src = sniperImages[2]; }, 40000);

  const ctx = overlay.getContext('2d');

  function resizeOverlay(){ overlay.width = camera.offsetWidth; overlay.height = camera.offsetHeight; }
  await new Promise(res => setTimeout(res, 250));
  resizeOverlay();

  // 初期照準
  let scopeX = Math.random()*(overlay.width-300);
  let scopeY = Math.random()*(overlay.height-300);
  scope.style.left = (camera.offsetLeft + scopeX) + "px";
  scope.style.top = (camera.offsetTop + scopeY) + "px";

  // ランダム移動
  function moveScopeRandom(){
    const camWidth = overlay.width;
    const camHeight = overlay.height;
    scopeX = Math.random()*(camWidth-300);
    scopeY = Math.random()*(camHeight-300);
    scope.style.left = (camera.offsetLeft + scopeX) + "px";
    scope.style.top = (camera.offsetTop + scopeY) + "px";
  }
  moveScopeRandom();
  scopeTimer = setInterval(moveScopeRandom, 500); // 俊敏に

  // タイマー
  let remaining = gameTime;
  timerDisplay.textContent = formatTime(remaining);
  countdownInterval = setInterval(()=>{
    remaining--;
    timerDisplay.textContent = formatTime(remaining);
    if(remaining <= 0){ endGame(true); }
  }, 1000);

  let overlapStartTime = null;

  async function detectFaces(){
    if(gameEnded){ return; }
    if(camera.readyState < 2){ requestAnimationFrame(detectFaces); return; }

    const options = new faceapi.TinyFaceDetectorOptions({ inputSize:416, scoreThreshold:0.3 });
    const detections = await faceapi.detectAllFaces(camera, options);

    ctx.clearRect(0,0,overlay.width,overlay.height);

    let hit = false;
    const scaleX = overlay.width / camera.videoWidth;
    const scaleY = overlay.height / camera.videoHeight;

    detections.forEach(det => {
      const x = det.box.x * scaleX;
      const y = det.box.y * scaleY;
      const width = det.box.width * scaleX;
      const height = det.box.height * scaleY;

      const flippedX = x; // 左右反転修正
      const faceRect  = { left: flippedX, top: y, right: flippedX+width, bottom: y+height };

      // 顔枠表示
      ctx.strokeStyle = "lime";
      ctx.lineWidth = 2;
      ctx.strokeRect(faceRect.left, faceRect.top, width, height);

      const scopeRect = { left: scopeX, top: scopeY, right: scopeX+300, bottom: scopeY+300 };
      const overlap = !( scopeRect.right < faceRect.left ||
                         scopeRect.left > faceRect.right ||
                         scopeRect.bottom < faceRect.top ||
                         scopeRect.top > faceRect.bottom );

      if(overlap) hit = true;
    });

    if(hit){
      if(!overlapStartTime) overlapStartTime = performance.now();
      scope.style.borderColor = "yellow"; // 重なったら光る
      if(performance.now() - overlapStartTime >= 1000){ // 1秒でアウト
        showHitEffect(scopeX, scopeY);
        return;
      }
    } else {
      overlapStartTime = null;
      scope.style.borderColor = "red"; // 通常色
    }

    requestAnimationFrame(detectFaces);
  }

  detectFaces();
}

// アウト表示
function showHitEffect(x, y){
  clearInterval(scopeTimer);
  clearInterval(countdownInterval);

  hitEffect.style.left = (camera.offsetLeft + x) + "px";
  hitEffect.style.top  = (camera.offsetTop + y) + "px";
  hitEffect.style.display = "block";

  gameEnded = true;

  setTimeout(()=>{
    hitEffect.style.display = "none";
    endGame(false);
  }, 1000);
}

// 終了処理
function endGame(win){
  gameEnded = true;
  gameArea.style.display = "none";
  endArea.style.display = "block";
  endImg.src = win ? endImages.win : endImages.lose;
  restartButton.style.display = "inline-block";
}

// リスタート
restartButton.addEventListener("click", async ()=>{
  endArea.style.display = "none";
  restartButton.style.display = "none";
  gameEnded = false;

  if(videoStream){
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }

  introArea.style.display = "block";
  introImg.src = "画像9.png";
  startButton.style.display = "inline-block";
  startButton.disabled = false;
  startButton.textContent = "ゲーム開始";
});

function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${s.toString().padStart(2,"0")}`;
}

// スタートボタン
startButton.addEventListener("click", async () => {
  startButton.disabled = true;
  startButton.textContent = "モデル読み込み中…";
  try {
    await loadModels();
  } catch (e) {
    alert("モデルの読み込みに失敗しました。");
    console.error(e);
    startButton.disabled = false;
    startButton.textContent = "ゲーム開始";
    return;
  }
  startButton.textContent = "読み込み完了。イントロへ…";
  await new Promise(r => setTimeout(r,400));
  showIntro();
});
</script>
</body>
</html>
